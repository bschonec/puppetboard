{% extends 'layout.html' %}
{% block content %}

<p>Scroll to: <a href="#logs">Logs</a>, <a href="#events">Events</a>, <a href="#metrics">Metrics</a></p>.

<h1>Summary</h1>
<table class='ui basic table'>
  <thead>
    <tr>
      <th>Certname</th>
      <th>Configuration version</th>
      <th>Start time</th>
      <th>End time</th>
      <th>Duration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="{{url_for('node', env=current_env, node_name=report.node)}}">{{ report.node }}</a></td>
      <td>
        {{report.version|safe}}
      </td>
      <td rel="utctimestamp">
        {{report.start}}
      </td>
      <td rel="utctimestamp">
        {{report.end}}
      </td>
      <td>
        {{report.end - report.start}}
      </td>
    </tr>
  </tbody>
</table>

<h1 id="logs">Logs</h1>
<table id="logs_table" class='ui basic compact fixed wrapped table'>
  <thead>
    <tr>
      <th>Timestamp</th>
      <th>Source</th>
      <th>Tags</th>
      <th>Message</th>
      <th>Location</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<h1 id="events">Events</h1>
<table id="events_table" class='ui basic compact fixed wrapped table'>
  <thead>
    <tr>
      <th class="four wide">Resource</th>
      <th class="two wide">Status</th>
      <th class="two wide">Changed From</th>
      <th class="eight wide">Changed To</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<h1 id="metrics">Metrics</h1>
<table class="ui basic table compact">
  <thead>
    <tr>
      <th>Category</th>
      <th>Name</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    {% for metric in metrics %}
      <tr>
        <td>{{metric.category}}</td>
        <td>{{metric.name}}</td>
        <td>{{metric.value|round(2)}}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock content %}

{% block onload_script %}

$.fn.dataTable.ext.errMode = 'throw';

// Init datatable for Logs
var logs = {{ logs|tojson }}
var logs_table = $('#logs_table').DataTable({

    "data": logs,
    'columns': [
        { data: 'timestamp' },
        { data: 'source' },
        { data: 'tags' },
        { data: 'message' },
        { data: 'location' },
    ],

    "paging": false,

    'createdRow': function (row, data, index) {
        if (data['level'] == 'info' || data['level'] == 'notice') {
            $(row).addClass('positive');
        } else if (data['level'] == 'warning') {
            $(row).addClass('warning');
        } else {
            $(row).addClass('error');
        }
    },
});

// Init datatable for Events
var events = {{ events|tojson }}
var events_table = $('#events_table').DataTable({

    "data": events,
    'columns': [
        { data: 'resource' },
        { data: 'status' },
        { data: 'old' },
        { data: 'new' },
    ],

    "ordering": false,
    "paging": false,

    createdRow: function (row, data, index) {
        if (!data['failed'] && data['old'] != data['new']) {
            $(row).addClass('ui line changed');
        } else if (data['failed']) {
            $(row).addClass('ui line failed');
        } else {
            $(row).addClass('ui line ' + data['status']);
        }
    },
});

{% endblock onload_script %}
